@(groupId : String, groupName : String, userId : String, inviteToken : String) @template2(1){


}{

<script type="text/javascript" src="/assets/this/js/adapter.js"></script>
<script type="text/javascript" src="/assets/this/js/hyper.socket.js"></script>
<script type="text/javascript" src="/assets/this/js/hyper.timeline.js"></script>
<script type="text/javascript" src="/assets/this/js/scripts.js"></script>
<!-- <script type="text/javascript" src="/assets/this/js/screen.js"></script> -->

<div id="timeQueryStringModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Time HyperLink</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>URL:</label>
                    <input type="text" class="form-control" id="timeQueryString">
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-default btn-info" onclick="copyLink()">Select</button>
            </div>
        </div>
    </div>
</div>

<div id="removeMemberModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Remove member</h4>
            </div>
            <div class="modal-body">
                Are you sure you want to remove <b id="removeUserName"></b> from this group?
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-default btn-danger" id="removeUserButton">Remove</button>

            </div>
        </div>
    </div>
</div>


<div id="addMembersModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Add Member</h4>
            </div>
            <div class="modal-body">
                <label>Group invitation link</label>
                <div class="input-group">
                    <input type="text" class="form-control" id="invite"> <span
                        class="input-group-addon" onclick="createInvite2()"> Create
						</span> <span class="input-group-addon" onclick="deleteInvite2()">
							Delete </span>
                </div>
                <label>Add Members manually</label>


                <form role="search" class="form">

                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search"
                               id="searchCandidateText"
                               data-provide="typeahead" autocomplete="off"/>
                        <span class="input-group-addon">
                            <i class="glyphicon glyphicon-search"></i>
                        </span>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<div id="participantModal" class="modal fade" role="dialog" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">What do you want to do?</h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="panel panel-red" onclick="kurentoStart(0)">
                            <div class="panel-heading" style="text-align: center;">
                                <i class="fa fa-video-camera" style="font-size: 6em;"></i>
                            </div>
                            <a href="#">
                                <div class="panel-footer">
                                    <span class="pull-left">Share camera</span>
                                    <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="panel panel-primary" onclick="kurentoStart(2)">
                            <div class="panel-heading " style="text-align: center;">
                                <i class="fa fa-eye" style="font-size: 6em;"></i>
                            </div>
                            <a href="#">
                                <div class="panel-footer">
                                    <span class="pull-left">Watch only</span>
                                    <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="panel panel-green" onclick="returnToHome()">
                            <div class="panel-heading " style="text-align: center;">
                                <i class="fa fa-sign-out" style="font-size: 6em;"></i>
                            </div>
                            <a href="#">
                                <div class="panel-footer">
                                    <span class="pull-left">Return</span>
                                    <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                    </div>

                    <!--
                   <div class="col-md-4">
                       <div class="panel panel-green" onclick="kurentoStart(1)">
                           <div class="panel-heading " style="text-align: center;">
                               <i class="fa fa-desktop" style="font-size: 6em;"></i>
                           </div>
                           <a href="#">
                               <div class="panel-footer">
                                   <span class="pull-left">Share screen</span>
                                   <span class="pull-right"><i class="fa fa-arrow-circle-right"></i></span>
                                   <div class="clearfix"></div>
                               </div>
                           </a>
                       </div>
                   </div>
                    -->
                </div>
            </div>
        </div>
    </div>
</div>

<div id="createTagModal" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Create TAG</h4>
            </div>
            <form id="createTagForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="control-label">TAG Name:</label>
                        <input class="form-control" type="text" id="tagTitle"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="input-group pull-right">
                        <input type="submit" class="btn btn-success" id="addMembers"/>
                    </div>
                    <div class="clearfix"></div>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="center">
    <div class="row">
        <div class="col-sm-12">
            <div class="panel panel-info not-fullscreen">
                <div class="btn-group pull-right">
                    <div class="form-inline">
                        <div class="btn btn-warning" onclick="playStop()" id="playStop">
                            <i class="fa fa-pause"></i>
                        </div>
                        <div class="btn btn-primary" onclick="timeline.setRealtime()"
                             id="goToPresent">
                            <i class="fa fa-step-forward"></i>
                        </div>
                        <div class="btn btn-info" onclick="setTimeLink()"
                             data-toggle="modal" data-target="#timeQueryStringModal">
                            <i class="fa fa-link"></i>
                        </div>
                        <div class="btn btn-success"
                             data-toggle="modal" data-target="#createTagModal">
                            <i class="fa fa-tag"></i>
                        </div>
                        <div class="btn btn-primary hidden" onclick="saveTags()"
                             id="saveButton">
                            <i class="fa fa-floppy-o"></i>
                        </div>
                    </div>
                </div>
                <div class="panel-heading" data-toggle="collapse"
                     data-target="#collapse3">
                    <h4 class="panel-title">Timeline</h4>
                </div>
                <div id="collapse3" class="panel-collapse collapse in">
                    <div class="panel panel-default container-full"
                         style="margin-bottom: 0px;">
                        <div id="timeline"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="panel panel-info ">
                <div class="btn-group pull-right">
                    <button class="btn btn-default" onclick="toggleAutoSelect()">
                        <i id="autoSelect" class="fa fa-thumb-tack"></i>
                    </button>
                    <button class="btn btn-default" onclick="toggleMicrophone()">
                        <i id="soundIcon" class="fa fa-microphone text-success"></i>
                    </button>
                    <button type="button" class="btn btn-primary"
                            onclick="toggleVideo()">
                        <i id="toggleVideo" class="fa fa-users"></i>
                    </button>
                    <button type="button" class="btn btn-primary"
                            onclick="toggleVideoSize()">
                        <i class="fa fa-expand"></i>
                    </button>
                </div>
                <div class="panel-heading" data-toggle="collapse"
                     data-target="#collapse0">
                    <h4 class="panel-title">Video</h4>
                </div>
                <div id="collapse0" class="panel-collapse collapse in">
                    <div class="panel-body" id="videoPanel">
                        <button type="button" id="minimizeVideo" class="btn btn-primary" onclick="toggleVideoSize()"
                                style="display:none;z-index:9999;position:absolute;right:0px">
                            <i class="fa fa-compress"></i>
                        </button>
                        <div id="videoWrapper">
                            <div id="currentTag"></div>
                            <div id="mainVideoContent">
                                <div id="previewContent"></div>
                            </div>
                            <video id='ownvideo' autoplay muted></video>
                            <video id='myvideo' autoplay></video>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <video id='onlyAudio' autoplay class="hidden"></video>
        <div class="col-md-4">
            <div class="panel panel-info">
                <div class="btn-group pull-right">
                    <button type="button" class="btn btn-success" id="addMembers" data-toggle="modal"
                            data-target="#addMembersModal">
                        <i class="fa fa-plus"></i>
                    </button>
                </div>
                <div class="panel-heading" data-toggle="collapse" data-target="#collapse1">
                    <h4 class="panel-title">Users</h4>
                </div>
                <div id="collapse1" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <ul class="media-list">
                            <li class="media">
                                <div class="media-body" id="videoMembers"></div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="panel panel-info not-fullscreen">
                <div class="panel-heading" data-toggle="collapse"
                     data-target="#collapse2">
                    <h4 class="panel-title">Recent chat history</h4>
                </div>
                <div id="collapse2" class="panel-collapse collapse in">
                    <div class="panel-body" style="max-height: 336px; overflow: auto;"
                         id="messagesPanel">
                        <ul class="media-list" id="messagesList">
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <input type="text" class="form-control"
                                   placeholder="Enter Message" id="messageText"
                                   onkeydown="if(event.keyCode==13){sendMessage();}"/>
						<span class="input-group-btn">
							<button class="btn btn-info" type="button" id="sendMessageButton"
                                    onclick="sendMessage()">Send
                            </button>
						</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-8">
            <div class="panel panel-info not-fullscreen">
                <div class="panel-heading" data-toggle="collapse"
                     data-target="#collapse5">
                    <h4 class="panel-title">Content editor</h4>
                </div>
                <div id="collapse5" class="panel-collapse collapse in">
                    <form class="form">
                        <div class="panel-body">
                            <label>Begin:</label>
                            (timeline <input type="checkbox" id="beginSync"/>)

                            <div class='input-group date' id='datetimepicker1'>
                                <input type='text' class="form-control" id="contentStart"/> <span
                                    class="input-group-addon"> <span
                                    class="glyphicon glyphicon-calendar"></span>
							</span>
                            </div>
                            <label>End:</label>
                            (timeline <input type="checkbox" id="endSync"/>)


                            <div class='input-group date' id='datetimepicker2'>
                                <input type='text' class="form-control" id="contentEnd"/> <span
                                    class="input-group-addon"> <span
                                    class="glyphicon glyphicon-calendar"></span>
							</span>
                            </div>
                            <div class="form-group">
                                <label>Content:</label>
                                <textarea class="form-control" rows="5" id="contentText" name="content"></textarea>
                            </div>
                            <div class="input-group">
                                <label>Is Caption:</label> <input type="checkbox"
                                                                  id="contentCaption" checked/>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <div class="btn-group input-group pull-right">
                                <button type="button" class="btn btn-danger"
                                        onclick="clearContent()">
                                    <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
                                    Clear
                                </button>
                                <button type="button" class="btn btn-info"
                                        onclick="previewContent()">
                                    <span class="glyphicon glyphicon glyphicon-eye-open" aria-hidden="true"></span>
                                    Preview
                                </button>
                                <button type="button" class="btn btn-success"
                                        onclick="createContent()">
                                    <span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>
                                    Save
                                </button>
                            </div>
                            <div class="clearfix"></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
		var group = true;
		var selectedUser = "@userId";
		var savedUser = "@userId";
		var real_time = true;
		var unsaved_tags = [];
		var firstRecording = true;
		var participants = {};
		var timeline = null;
		var current_offset = 0;
		var oldestMsg = null;
		var localContent = [];
		var moreContent = true;
		var contentTimer = null;
		var autoSelect = false;
		var fullscreen = false;
		function setTimeLink(){
			$("#timeQueryString").val(window.location.href.split("?")[0] + "?time=" +timeline.getMyTime().toISOString() );
		}
		
		function toggleAutoSelect(){
			autoSelect = !autoSelect;
			$("#autoSelect").attr("class",autoSelect ? "fa fa-thumb-tack text-off":"fa fa-thumb-tack");

		}

		function returnToHome(){
		    document.location = "/";
		}
		
		function toggleVideoSize(){
			fullscreen = !fullscreen;
			if(fullscreen){
				$("#videoPanel").attr("class","fullscreen");
				$("#minimizeVideo").show();
				$(".not-fullscreen").hide();

			}
			else {
				$("#videoPanel").attr("class","panel-body");
				$("#minimizeVideo").hide();
				$(".not-fullscreen").show();

			}	
		}
		
		function toggleMicrophone(){
			var microphoneState = Kurento.toggleMicrophone();
			if(microphoneState){
				$("#soundIcon").attr("class","fa fa-microphone text-success");
			} else {
				$("#soundIcon").attr("class","fa fa-microphone-slash text-danger");
			}
		}
		
		function receiveMore() {
			if (oldestMsg) {
				Kurento.receiveMore(oldestMsg, 1);
			}
		}
		
		function intervalRecorded(array) {
			console.log("REC", array);
			for ( var id in array) {
				var start = array[id][0];
				var end = array[id][1];
				timeline.setRecord(id, start, end);
			}
			if (firstRecording) {
				firstRecording = false;

				timeline.fit({
					animation : false
				});
			}
		}

		function videoStream(streamUrl) {
			var video = document.getElementById("myvideo");
			video.src = streamUrl;
			return video;
		}

		function setTime(time) {
			console.log("setTime",time);
			timeline.setTime(time);
		}

		function mixedStream(streamUrl) {
			var video = document.getElementById("onlyAudio");
			video.src = streamUrl;
			return video;
		}

		function participantInfo(info) {
			var userId = info.id;
			var name = info.name;
			var photo = info.photo;
			var online = info.online;
			console.log("*",info);
			if (!participants[userId]) {
				participants[userId] = true;
			
				var del_button = "<i style='color:red' onclick='removeMemberConfirmation(\""+ userId+ "\",\""+name+"\")' class='fa fa-times'></i>";
				var onclick = 'onclick=\'selectUser("'+userId+'")\'';
				var style='style="background-image:url('+photo+');height:40px;width:40px" class="pull-left media-object circular"';
				var audio ='<i style="top:-12px;left:-24px;position:relative" id="mic'+userId+'" class="fa fa-microphone text-off"></i>';
				
				$("#videoMembers").append(
					'<div id="vidMember'+userId+'" '+ onclick+'>'+
					'<a '+style+'>'+audio+'</a>'+
					'<div class="media-body"><h5>'+name+' '+del_button+'</h5><small class="text-muted">Active From 3 hours</small></div></div>'
				);		
			}
			
			if(online){
				$("#vidMember" + userId).attr('class', "media circular-online");
			}else {
				$("#vidMember" + userId).attr('class', "media circular-offline");
				$("#mic"+userId).attr("class","fa fa-microphone text-off");
			}
		}

		function tagArrived(id, time, title, content) {
			console.log(id, time, title, content);
			timeline.loadTag(id, time, title, content);
		}


		function talkArrived(userId,value){
			if(value){
				if(autoSelect){
					selectUser(userId);
				}
				$("#mic"+userId).attr("class","fa fa-microphone text-success");
			}else {
				$("#mic"+userId).attr("class","fa fa-microphone text-off");
			}
		}
		
		function messageArrived(userId, time, text, name, mid, seq) {
			var html = '<li class="media"><div class="media-body"><div class="media">'
					+ '<a class="pull-left" href="#"><img class="media-object img-circle"  style="height: 40px;" src="/photo/'+userId+'" /></a>'
					+ '<div class="media-body">' + text + '<br />'
					+' <small class="text-muted">' + name + ' | ' + time + '</small>' 
					+ '<hr /></div></div></div></li>';

			if (!oldestMsg || seq < oldestMsg) {
				oldestMsg = seq;
				var oldHeight = $("#messagesList").height();
				$("#messagesList").prepend(html);
				var newHeight = $("#messagesList").height();
				$("div").scrollTop(newHeight - oldHeight);

			} else {
				$("#messagesList").append(html);
				$("div").scrollTop($("#messagesList").height());
			}

			if (!$('#messagesPanel').hasScrollBar()) {
				receiveMore();
			}
		}

		function sendMessage() {
			var text = $("#messageText").val();
			Kurento.sendMessage(text);
			$("#messageText").val("");

		}

		function playStop() {
			timeline.togglePlayStop(function() {
				$("#playStop").html('<i class="fa fa-pause"></i>');
				$("#playStop").attr('class', 'btn btn-warning');
				Kurento.setPlay(true);
			}, function() {
				$("#playStop").html('<i class="fa fa-play"></i>');
				$("#playStop").attr('class', 'btn btn-success');
				Kurento.setPlay(false);
			});
		}

		function selectUser(userId){
			savedUser = selectedUser = userId;
			setVideoIcon();
			if (real_time) {
				Kurento.receiveRealtime(selectedUser);
			} else {
				Kurento.receiveHistoric(selectedUser, current_offset);
			}
		}

		
		function setVideoIcon(){
			$("#toggleVideo").attr("class",selectedUser==null ? "fa fa-users":"fa fa-user");
		}
		
		function toggleVideo() {
			selectedUser = selectedUser!=null ? null: savedUser;
			setVideoIcon();
			if (real_time) {
				Kurento.receiveRealtime(selectedUser);
			} else {
				Kurento.receiveHistoric(selectedUser, current_offset);
			}
		}

		function saveTags() {
			console.log(unsaved_tags);
			for ( var i in unsaved_tags) {
				var tag = unsaved_tags[i];
				var visTag = timeline.getRecord(tag.id);
				var time = new Date(visTag.start);

				var title = tag.title;
				var content = tag.content;
				Kurento.createTag(time, title, content);
				timeline.removeTag(tag.id);
			}
			unsaved_tags = [];
			$("#saveButton").addClass("hidden");
		}

		function clearContent(){
			$("#contentText").val("");
			$("#previewContent").html("");
			
			$(".selectedDelete").each(function(index){
				Kurento.deleteContent($(this).attr("cid"));
			});

		}
		
		function createContent(){
			var start = parseTime($("#contentStart").val());
			var end = parseTime($("#contentEnd").val());			
			var content = getContent();
			
			if(content){
				Kurento.createContent(start.toISOString(),end.toISOString(),content);
			}
			clearContent();
		}
		
		function getContent(){
			var content = $("#contentText").val();
			if(!content || content.length==0){
				return null;
			}

			if($("#contentCaption").is(':checked')){
				content = '<div class="caption"><span>'+content+'</span></div>';
			}
			return content;
		}
		
		function previewContent(){
			$("#previewContent").html(getContent());
		}
		
		function addContent(key, content) {


			$("#mainVideoContent").append('<div id="content'+ key + '">'+content+'</div>');
			$("#content"+key).click(function(){
				if($(this).attr("selected")){
					$(this).attr("selected",false);
					$(this).attr("class","");
				}else {
					$(this).attr("selected",true);
					$(this).attr("class","selectedDelete");
					$(this).attr("cid",key);
				}
			});
		}
		
		

		function removeContent(key) {
			$("#content" + key).remove();
			delete localContent[key];
		}

		function renderContent() {
			var currentTime = new Date().getTime() - current_offset;

			while (localContent.length != 0) {
				var entry = localContent[0];
				var time = new Date(entry.time);

				if (time.getTime() <= currentTime) {
					localContent.shift();
					if (entry.type == "start") {
						addContent(entry.id, entry.content);
					} else if (entry.type == "end") {
						removeContent(entry.id);
					}
					console.log("render",entry,localContent);

				} else {
					break;
				}
			}
			var hasStarts = false;
			for ( var i in localContent) {
				var entry = localContent[i];
				if (entry.type == "start") {
					hasStarts = true;
					break;
				}

			}
			if (localContent.length == 0) {
				// no content, keep calm 
			} else if (!hasStarts) {	
				if(moreContent){
					// all events started, check if others may start
					Kurento.getContent();
				}else {
					// there are ends
					scheduleRender(currentTime);
				}
			} else {
				// wait for next event
				scheduleRender(currentTime);
			}
		}

        function scheduleRender(currentTime){
            if(timeline.timeRunning){
                var time = new Date(localContent[0].time);
                if(contentTimer!=null){
                    clearTimeout(contentTimer);
                }
                contentTimer = setTimeout(function() {
                    contentTimer = null;
                    renderContent();
                }, time.getTime() - currentTime);
            }
        }


		function onContentArrived(content,more) {
			moreContent = more;
			$("#mainVideoContent div").not(':first').remove();

			console.log(content);
			localContent = content.sort(function(a, b) {
				return new Date(a.time).getTime() - new Date(b.time).getTime();
			});
			renderContent();
		}


	    var candidateSearch = new (function() {

            this.source = function(query,process){
       			Signaling.searchGroupCandidates("@groupId", query, function(array){
       			    console.log(array);
                    process(array);
       			});
            };

            this.displayText = function(item){
                return item.name;
            };

            this.highlighter = function(item){
                return "<i class='fa fa-user'></i> "  + item.name;
            };

            this.matcher = function(item){
                return true;
            };

            this.updater = function(item){
                console.log(item);
               	Kurento.addUserGroup(item.id);
			    $("#addMembersModal").modal("hide");
                return item;
            }

            return this;
        })();

        function extractTextFromXml(xml){
           // var obj = $.parseXML( xml );
            return xml.replace(/<[^>]*>/g, "");
        }


		var generalSearch = {
			source: function(query,process){
				Signaling.searchInsideGroup("@groupId",query, function( array ) {
					process(array);
				});			
			},
			displayText: function(item){
				if(item.type=="tag"){
				    return item.title;
			    }else if(item.type=="html"){
			        console.log("displayText",item);
			        console.log("displayText",item.content);
			        return item.content;
			    }
			},
			highlighter: function(item){
				if(item.type=="tag"){
					return "<i class='fa fa-tag'></i> "  + item.title + " <small>("+friendlyTime(item.time)+")</small>";
				}else if(item.type=="html"){
					return "<i class='fa fa-font'></i> " + item.content;
				}
			},
			matcher: function(item){
				return true;
			},
			updater:function(item){
				if(item.type=="tag"){
					timeline.setHistoric(item.time);
				}
				else if(item.type=="html"){
					timeline.setHistoric(item.time);
				}
				return item;
			}
		};

		function copyLink(){
			$("#timeQueryString").select();
		}
		
		function createInvite2(){
			Signaling.createInvite("@groupId",function(token){
				$("#invite").val($(location).attr('protocol')+"//"+$(location).attr('host')+"/join/@groupId/" + token);	
			});
		}

		function deleteInvite2(){
			Signaling.deleteInvite("@groupId",function(){
				$("#invite").val("");	
			});
		}
		
		function removeMemberConfirmation(uid,name){
			$("#removeMemberModal").modal("show");
			$("#removeUserName").html(name);
			$("#removeUserId").val(uid);
			$("#removeUserButton").click(function(){
				Kurento.removeUserGroup(uid);
				$("#removeMemberModal").modal("hide");
			});
		}


		function participantRemoved(uid) {
            $("#vidMember"+uid).remove();
            participants[uid]=false;
            if(uid=="@userId"){
                document.location = "/";
            }

		}


		
		function onKurentoOpen(){
			console.log("WebSocket Ok!");
			var attrs = parseQuery(document.location.search);
			if(attrs.time){
				timeline.setHistoric(new Date(attrs.time));
			}
		}

		function localVideo(streamUrl){
      			var video = document.getElementById("ownvideo");
			video.src = streamUrl;
		}

		function kurentoStart(mode){
			Kurento.start("@groupId",mode,  onKurentoOpen ,participantInfo, videoStream,
			                                mixedStream, intervalRecorded, messageArrived,
			                                tagArrived, onContentArrived,talkArrived,setTime,
			                                participantRemoved,localVideo);
			$('#participantModal').modal('hide');
		}


     function dateStr(date) {


        var curr_year = date.getFullYear();

        var curr_month = date.getMonth() + 1; //Months are zero based
        if (curr_month < 10)
            curr_month = "0" + curr_month;

        var curr_date = date.getDate();
        if (curr_date < 10)
            curr_date = "0" + curr_date;

        var curr_hour = date.getHours();
        if (curr_hour < 10)
            curr_hour = "0" + curr_hour;

        var curr_min = date.getMinutes();
        if (curr_min < 10)
            curr_min = "0" + curr_min;

        var curr_sec = date.getSeconds();
        if (curr_sec < 10)
            curr_sec = "0" + curr_sec;

        return curr_date + "/" + curr_month + "/" + curr_year + " " + curr_hour + ":" + curr_min + ":" + curr_sec;

    }

		$(document).ready(function() {
			switchTab("#mytabs","#mybtns",1);
			$('#participantModal').modal('show');
			$('#searchNav').show();
			$('#searchText').typeahead(generalSearch);

			$('#searchCandidateText').typeahead(candidateSearch);

			setVideoIcon();
			$("#navbar-list").append("<li><a>@groupName</a></li>");
			
			
			$("#createTagForm").submit(function(event){
				event.preventDefault();
				$("#createTagModal").modal('hide');
				var id = makeid();
				var title = $("#tagTitle").val();
				var content = "";

				unsaved_tags.push({
					id : id,
					title : title,
					content : content
				});
				timeline.addTag(id, title);
				$("#saveButton").removeClass("hidden");
			});
			
			
			
			$("#refresh-button").click(function() {
				document.location = document.location;
			});
			
			$("#home-button").click(function() {
				document.location = "/";
			});
	
			@if(inviteToken!=null){
				$("#invite").val($(location).attr('protocol')+"//"+$(location).attr('host')+"/join/@groupId/@inviteToken");	
			}
		
			$('#datetimepicker1').datetimepicker({
				format : 'DD/MM/YYYY HH:mm:ss',
				defaultDate : new Date(),
				showTodayButton:true

			});
			$('#datetimepicker2').datetimepicker({
				format : 'DD/MM/YYYY HH:mm:ss',
				defaultDate : new Date(new Date().getTime()+1000),
				showTodayButton:true

			});

			$("#messagesPanel").scroll(function() {
				if ($("#messagesPanel").scrollTop() == 0) {
					receiveMore();
					$("#messagesPanel").scrollTop(1);
				}
			});

			// plugtrade.com - jQuery detect vertical scrollbar function //
			(function($) {
				$.fn.hasScrollBar = function() {
					var divnode = this.get(0);
					if (divnode.scrollHeight > divnode.clientHeight)
						return true;
				}
			})(jQuery);

			timeline = HyperTimeline.create("timeline",
				function(offset) {
					console.log("HISTORIC", offset);
					// current request
					current_offset = offset;
					Kurento.receiveHistoric(selectedUser, current_offset);
					real_time = false;

				}, function() {
					console.log("REALTIME");
					// realtime request
					Kurento.receiveRealtime(selectedUser);
					real_time = true;
				}, function(tag){
				    if(tag!=null){
                        $("#currentTag").html(tag.text);
                    }else {
                        $("#currentTag").html("");
                    }
                },function(time){
                    console.log("onDrop",time);
                    if($("#beginSync").is(':checked')){
                        $("#contentStart").val(dateStr(new Date(time)));
                    }
                    if($("#endSync").is(':checked')){
                        $("#contentEnd").val(dateStr(new Date(time)));
                    }

                }

			);
		});	


</script>
}
