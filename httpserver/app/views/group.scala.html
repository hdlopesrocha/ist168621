@(groupId : String, groupName : String, userId : String) @template(1){
<script type="text/javascript" src="/assets/js/jquery.js"></script>
<script type="text/javascript" src="/assets/js/adapter.js"></script>
<script type="text/javascript" src="/assets/js/signaling.js"></script>
<script type="text/javascript" src="/assets/js/participant.js"></script>
<script type="text/javascript" src="/assets/js/kurento_main.js"></script>
<script type="text/javascript" src="/assets/js/kurento_sender.js"></script>
<script type="text/javascript" src="/assets/js/kurento_receiver.js"></script>
<script type="text/javascript" src="/assets/js/webrtc.js"></script>
<script type="text/javascript" src="/assets/timeline/vis.js"></script>
<script type="text/javascript" src="/assets/js/hyper_timeline.js"></script>
<link type="text/css" href="/assets/timeline/vis.css" rel="stylesheet" />

<h1>@groupName</h1>

	<div class="col-sm-6">
		<div class="panel panel-default">
			<h3>Add Members</h3>
			&nbsp;Search:<input type="text"
				onchange="candidate_search(this.value)" />
			<ul id="candidate-list"></ul>
		</div>
	</div>


	<div class="col-sm-6">
		<div class="panel panel-default">
			<h3>Members List</h3>
			<ul id="member-list"></ul>
		</div>
	</div>

	<div class="col-sm-12">
		<div class="panel panel-default">
			<h3>Remote Video</h3>
			<div id="participants"></div>
			<div id="timeline"></div>
		</div>
	</div>

<script>
	var currentVideoPlaying = 0;
	var participants = {};
	var user_current = {};
	var user_streams = {};
	var user_videos = {};
	var rec_videos = [];
	var timeline = null;
	var last_sequence = -1;
	var current_interval = null;
	var rendered_intervals = {};

	// TIMELINE
	var items = new vis.DataSet({
		type : {
			start : 'ISODate',
			end : 'ISODate'
		}
	});



	$(document).ready(function() {
		
		var kvideo = function(userId, streamUrl) {
			var video = user_videos[userId];
			if (!video) {

				var newVideoId = "video" + userId;
				$("#participants").append("<video id='" + newVideoId + "' " + (userId == "@userId" ? "muted" : "") + " autoplay width='480px' height='360px'></video>");
				video = document.getElementById(newVideoId);
				video.src = streamUrl;
				user_videos[userId] = video;
				user_streams[userId] = streamUrl;

				video.addEventListener('ended', function() {
					//	++currentVideoPlaying;
					//	video.src= rec_videos[currentVideoPlaying];
					//	timeline.setSelection(currentVideoPlaying);
				});
			}
			return video;
		}

		var kparticipants = function(userId, email) {
			if (!participants[userId]) {
				$("#state"+userId).attr('class', "fa fa-circle" );				
				participants[userId] = email;
			}
		}

	
		timeline = HyperTimeline.create(items, "timeline",
			function(time) {
				console.log("HISTORIC",time);
				// current request
			}, 
			function() {

				console.log("REALTIME");
				// realtime request
			}
		);

		Signaling.subscribe("rec:@groupId",function() {
			console.log("video recorded!");

			Signaling.listRecordings("@groupId",last_sequence, function(data) {
				var first = last_sequence == -1;
				for ( var i in data) {
					var obj = data[i];
					if (obj.uid == "@userId") {
						rec_videos[obj.seq] =  obj.url;
						var inter = rendered_intervals[obj.inter];
						var newInter = null;
						if (!inter) {
							newInter = {
								id : obj.inter,
								content : "&nbsp;",
								start : obj.start,
								end : obj.end
							};
						} else {
							var oldStart = inter.start;
							//console.log("oldStart",oldStart);
							items.remove(obj.inter);
							newInter = {
								id : obj.inter,
								content : "&nbsp;",
								start : oldStart,
								end : obj.end
							};
						}
						items.add(newInter);
						rendered_intervals[obj.inter] = newInter;
						if (obj.seq > last_sequence) {
							last_sequence = obj.seq;
						}
					}
				}
				if (first) {
					timeline.fit({
						animation : false
					});
				}
			});
		});



		Kurento.start("@groupId", function() {
			KurentoSender.start("@userId");
			KurentoReceiver.start(kparticipants, kvideo);
		});

		$("#refresh-button").click(function() {
			document.location = document.location;
		});
		
		$("#home-button").click(function() {
			document.location = "/";
		});

		Signaling.listGroupMembers("@groupId",function(array) {
			var html = "";
			for ( var i in array) {
				var uid = array[i].uid;
				var del_button = "<button onclick='del_user_group(\""+ uid+ "\")'>remove</button>";
				//var sdp_button = "<button onclick='get_sdp(\""+array[i].mid+"\")'>sdp</button>";
				html += "<li><i id='state"+uid+"' class='fa fa-circle-o'></i> " + array[i].email	+ del_button + "</li>";
			}
			$("#member-list").html(html);
		});
	});

	function del_user_group(uid) {
		var success = function() {
			document.location = document.location;
		};
		Signaling.removeUserGroup("@groupId", uid, success);
	}

	function add_user_group(uid) {
		var success = function() {
			document.location = document.location;
		};
		Signaling.addUserGroup("@groupId", uid, success);
	}

	function candidate_search(query) {

		var result = function(array) {
			var html = "";
			for ( var i in array) {
				var uid = array[i].uid;
				var add_button = "<button onclick='add_user_group(\"" + uid	+ "\")'>add</button>";
				html += "<li>" + array[i].email + add_button + "</li>";
			}
			$("#candidate-list").html(html);
		};
		Signaling.searchGroupCandidates("@groupId", query, result);
	}
</script>
}
