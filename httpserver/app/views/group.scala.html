@(groupId : String, groupName : String, userId : String)

<html>
	<head>
		<script type="text/javascript" src="/assets/js/jquery.js"></script>	
		<script type="text/javascript" src="/assets/js/adapter.js"></script>	
		<script type="text/javascript" src="/assets/js/signaling.js"></script>
		<script type="text/javascript" src="/assets/js/participant.js"></script>
		<script type="text/javascript" src="/assets/js/kurento_main.js"></script>
		<script type="text/javascript" src="/assets/js/kurento_sender.js"></script>
		<script type="text/javascript" src="/assets/js/kurento_receiver.js"></script>
		<script type="text/javascript" src="/assets/js/webrtc.js"></script>	
		<script type="text/javascript" src="/assets/js/RecordRTC.js"></script>	
	  	<script type="text/javascript" src="/assets/timeline/vis.js"></script>
	  	<link type="text/css" href="/assets/timeline/vis.css" rel="stylesheet" />


	</head>
	<body>
		<button id="logout-button">Logout</button>		
		<button id="home-button">Home</button>
		<button id="refresh-button">Refresh</button>
		<h1>@groupName</h1>
		
		<h3>Add Members</h3>
		&nbsp;Search:<input type="text" onchange="candidate_search(this.value)"/>
		<ul id="candidate-list"></ul>
		
		
		<h3>Members List</h3>
		<ul id="member-list"></ul>
		
		<h3>Online Members</h3>
		<ul id="online-members"></ul>

		<h3>Local Video</h3>
		<div class="col-md-5">
			<video id="myvideo" autoplay width="120px" height="90px" poster="/assets/images/webrtc.png"></video>
		</div>
				
		<h3>Remote Video</h3>
		<div id="participants"></div>
		
		<h3>Recorded Video</h3>
		<div class="col-md-5">
			<div id="main" style="width:480px"></div>
			<video id="rec_video" controls autoplay width="480px" height="360px" poster="/assets/images/webrtc.png"></video>	
		</div>
		
		
		
		<script>
			var participants = {};
			var rec_videos = [];
			var timeline = null;
			// TIMELINE
		 	var items = new vis.DataSet({
				type: { start: 'ISODate', end: 'ISODate' }
			});
	
			
			$( document ).ready(function() {
				var rec_video = document.getElementById("rec_video");
				var currentVideoPlaying = 0;
				rec_video.muted = true;
				
				rec_video.addEventListener('ended', function(){
					++currentVideoPlaying;
					rec_video.src= rec_videos[currentVideoPlaying];
					timeline.setSelection(currentVideoPlaying);
				});
				
				
			  function createTimeline(items) {
				    var main = document.getElementById('main');
				    var options = {
			            stack: false,
			            align: 'center'
				     // editable: true,
				     // clickToUse: true
				    };

				    var timeline =  new vis.Timeline(main, items, options);
				    
				    timeline.on('select', function (properties) {
				       var sel = properties.items[0];
				       if(sel!=undefined){
				    	   	currentVideoPlaying = sel;
							rec_video.src= rec_videos[currentVideoPlaying];
				       }
				      });
				    
				    return timeline;
				}

	  
				timeline= createTimeline(items);

				
				
				
				var kparticipants = function(userId, email){
					if(!participants[userId]){
						$("#online-members").append("<li>"+email+"</li>");
						participants[userId] = email;						
					}
				}
			
				var kvideo = function(userId){
					var newVideoId = "video"+userId;
					$("#participants").append("<video id='"+newVideoId+"' "+ (userId=="@userId"?"muted":"")+ " controls autoplay width='480px' height='360px' poster='/assets/images/webrtc.png'></video>");
					return document.getElementById(newVideoId);
				}
					
				var myvideo = document.getElementById("myvideo");
				myvideo.muted = true;

				var rec_video_index = 0;

		
				
				
				var onVideoRecorded = function(blob,videoURL,start,end){
					console.log(start,end,videoURL,blob);
					rec_videos[rec_video_index] = videoURL;
					
					var itemsArray = [];
					itemsArray.push({id:rec_video_index,content:"&nbsp;",start:start,end:end});
					items.add(itemsArray);
					timeline.fit();
					var now = new Date();
					now.setSeconds(now.getSeconds() + 10);
					
					if(rec_video_index==0){
						rec_video.src = videoURL;
						timeline.setSelection(rec_video_index);
					}
					
					timeline.setWindow(rec_video_index==0 ? start:null,now);
					rec_video_index++;
					
					var formData = new FormData();
					formData.append("video", blob);
					Signaling.saveRecording("@groupId",start,end,formData,function(){console.log("ok")},function(){console.log("err")});
					
					
					
				}
				

				
				Kurento.start("@groupId", function(){
					KurentoSender.start("@userId",myvideo,onVideoRecorded);
					KurentoReceiver.start(kparticipants,kvideo);			
				});
				
				$("#logout-button").click(function(){
					Signaling.logout(function(){
						document.location = document.location;
					})
				});	
				$("#refresh-button").click(function(){
					document.location = document.location;
				});
				$("#home-button").click(function(){
					document.location = "/";
				});
				
				Signaling.listGroupMembers("@groupId", function(array){
					var html = "";
					for(var i  in array){
						var uid = array[i].uid;
						var del_button = "<button onclick='del_user_group(\""+uid+"\")'>remove</button>";
						//var sdp_button = "<button onclick='get_sdp(\""+array[i].mid+"\")'>sdp</button>";
						html += "<li>"+array[i].email+del_button+"</li>";
					}
					$("#member-list").html(html);
				});
	
				
			});
			
			function del_user_group(uid){
				var success = function(){
					document.location = document.location;
				};
				
				Signaling.removeUserGroup("@groupId",uid,success);
			}

			
			function add_user_group(uid){
				var success = function(){
					document.location = document.location;
				};
				
				Signaling.addUserGroup("@groupId",uid,success);
			}
			
			function candidate_search(query){
				
				var result = function(array){
					var html = "";
					for(var i  in array){
						var uid = array[i].uid;
						
						var add_button = "<button onclick='add_user_group(\""+uid+"\")'>add</button>";
						html += "<li>"+array[i].email+add_button+"</li>";
					}
					$("#candidate-list").html(html);	
				};
				Signaling.searchGroupCandidates("@groupId",query,result);
			}

			
			
			
			
		</script>
	</body>
</html>