@(groupId : String, groupName : String, userId : String)

<html>
	<head>
		<script type="text/javascript" src="/assets/js/jquery.js"></script>	
		<script type="text/javascript" src="/assets/js/adapter.js"></script>	
		<script type="text/javascript" src="/assets/js/signaling.js"></script>
		<script type="text/javascript" src="/assets/js/participant.js"></script>
		<script type="text/javascript" src="/assets/js/kurento_main.js"></script>
		<script type="text/javascript" src="/assets/js/kurento_sender.js"></script>
		<script type="text/javascript" src="/assets/js/kurento_receiver.js"></script>
		<script type="text/javascript" src="/assets/js/webrtc.js"></script>	
		<script type="text/javascript" src="/assets/js/RecordRTC.js"></script>	
	  	<script type="text/javascript" src="/assets/timeline/vis.js"></script>
	  	<script type="text/javascript" src="/assets/js/hyper_timeline.js"></script>
	  	<script type="text/javascript" src="/assets/js/hyper_preloader.js"></script>
	  	<link type="text/css" href="/assets/timeline/vis.css" rel="stylesheet" />


	</head>
	<body>
		<button id="logout-button">Logout</button>		
		<button id="home-button">Home</button>
		<button id="refresh-button">Refresh</button>
		<h1>@groupName</h1>
		
		<h3>Add Members</h3>
		&nbsp;Search:<input type="text" onchange="candidate_search(this.value)"/>
		<ul id="candidate-list"></ul>
		
		
		<h3>Members List</h3>
		<ul id="member-list"></ul>
		
		<h3>Online Members</h3>
		<ul id="online-members"></ul>

		<h3>Local Video</h3>
		<div class="col-md-5">
			<video id="myvideo" autoplay width="120px" height="90px" poster="/assets/images/webrtc.png"></video>
		</div>
				
		<h3>Remote Video</h3>
		<button onclick="realTime()">
			REAL TIME
		</button>
		
		<div id="participants"></div>
		
		<div id="timeline"></div>
		
		
		<script>
			var currentVideoPlaying = 0;
			var participants = {};
			var real_time = true;
			var user_current = {};
			var user_streams = {};
			var user_videos = {};
			var rec_videos = [];
			var timeline = null;
			var myvideo = document.getElementById("myvideo");
			myvideo.muted = true;
			var last_sequence = -1;
			var current_interval = null;
			var rendered_intervals = {};
			var preloader_timer = null;
			var preloader_running = false;
			
			// TIMELINE
		 	var items = new vis.DataSet({
				type: { start: 'ISODate', end: 'ISODate' }
			});
	
			function realTime(){
				real_time = true;
				
				for(var i in user_videos){
					user_videos[i].src = user_streams[i];
				}
		    	timeline.moveTo(new Date());
		    	timeline.hyper_offset = 0;
			}
			
			
			
			
			
			
			$( document ).ready(function() {
		
				var kvideo = function(userId, streamUrl){
					var video = user_videos[userId];
					if(!video){
					
						var newVideoId = "video"+userId;
						$("#participants").append("<video id='"+newVideoId+"' "+ (userId=="@userId"?"muted":"")+ " autoplay width='480px' height='360px' poster='/assets/images/webrtc.png'></video>");
						video = document.getElementById(newVideoId);
						video.src=streamUrl;
						user_videos[userId] = video;
						user_streams[userId] = streamUrl;
						
						video.addEventListener('ended', function(){
						//	++currentVideoPlaying;
						//	video.src= rec_videos[currentVideoPlaying];
						//	timeline.setSelection(currentVideoPlaying);
						});
					}
					return video;
				}
				
				var kparticipants = function(userId, email){
					if(!participants[userId]){
						$("#online-members").append("<li>"+email+"</li>");
						participants[userId] = email;						
					}
				}
			
				
				
				function preloader(){
					if(!preloader_running && !real_time){
						preloader_running = true;
						console.log("GET GET GET GET GET GET");
						
						$.get("/api/rect/@groupId/"+timeline.getMyTime().toISOString()+"/20000",function(data){
							
							var array = JSON.parse(data);
							
							for(var i in array){
								var obj = array[i];
								var start = new Date(obj.start);
								var end = new Date(obj.end);
								var newUrl = "/file/"+obj.url;
								var srcOrBlob = HyperPreLoader.load(newUrl,obj.type);
								var offset = timeline.intersects(start,end);
								
								if(offset ){	
											console.log("CT",offset);
									if(!user_videos[obj.uid]){
										kvideo(obj.uid,"");
									}
									
									if(user_current[obj.uid]!==newUrl){

										var video = user_videos[obj.uid];
										video.src= srcOrBlob;
										$(video).unbind('loadedmetadata');
										$(video).on('loadedmetadata', function() {
											
											video.currentTime = offset/1000;
									    }); 
										user_current[obj.uid] = newUrl;
									}
								}
							}
						}).always(function() {
							preloader_running = false;
							// waits if not waiting already
							if(preloader_timer==null){
								preloader_timer = setTimeout(function(){
									console.log("5 SECONDS!!!");
									preloader_timer = null;
									preloader();
								},5000);
							}
						});
					}
				}
						
				timeline= HyperTimeline.create(items,"timeline",function(){
					if(preloader_timer!=null){
				    	clearTimeout(preloader_timer);
				    	preloader_timer = null;
				    }
					real_time = false;
				    preloader();
				});
				
				
				Signaling.subscribe("rec:@groupId",function(){
					console.log("video recorded!");
					
					Signaling.listRecordings("@groupId",last_sequence,function(data){
						var first = last_sequence==-1;
						for(var i in  data){
							var obj = data[i];	
							if(obj.uid == "@userId"){
								rec_videos[obj.seq] = "/file/"+obj.url;
								
								var inter = rendered_intervals[obj.inter];					
								var newInter = null;								
								if(!inter){
									newInter = {id:obj.inter,content:"&nbsp;",start:obj.start,end:obj.end}; 
								}
								else {
									var oldStart = inter.start;
									console.log(oldStart);
									items.remove(obj.inter);
								 	newInter = {id:obj.inter,content:"&nbsp;",start:oldStart,end:obj.end};
								}
								items.add(newInter);
								rendered_intervals[obj.inter] = newInter;
								
								if(obj.seq > last_sequence){
									last_sequence = obj.seq;
								}
							}
						}
						if(first){
							timeline.fit({animation:false});
						}
				
					});
				});
				
				
				var onVideoRecorded = function(blob,videoURL,start,end){
					
					console.log(start,end,videoURL,blob);
					var formData = new FormData();
					var name = "recording"+"."+blob.type.split('/')[1];
					var type = blob.type;
					formData.append("video", blob,name);					
					Signaling.saveRecording("@groupId","@userId",current_interval,start.toISOString(),end.toISOString(),
							name,type,formData,function(data){current_interval = data;},function(){console.log("err")});
					
				}
				

				
				Kurento.start("@groupId", function(){
					KurentoSender.start("@userId",myvideo,onVideoRecorded);
					KurentoReceiver.start(kparticipants,kvideo);			
				});
				
				$("#logout-button").click(function(){
					Signaling.logout(function(){
						document.location = document.location;
					})
				});	
				$("#refresh-button").click(function(){
					document.location = document.location;
				});
				$("#home-button").click(function(){
					document.location = "/";
				});
				
				Signaling.listGroupMembers("@groupId", function(array){
					var html = "";
					for(var i  in array){
						var uid = array[i].uid;
						var del_button = "<button onclick='del_user_group(\""+uid+"\")'>remove</button>";
						//var sdp_button = "<button onclick='get_sdp(\""+array[i].mid+"\")'>sdp</button>";
						html += "<li>"+array[i].email+del_button+"</li>";
					}
					$("#member-list").html(html);
				});
	
				
				
				
				
			});
			
			function del_user_group(uid){
				var success = function(){
					document.location = document.location;
				};
				
				Signaling.removeUserGroup("@groupId",uid,success);
			}

			
			function add_user_group(uid){
				var success = function(){
					document.location = document.location;
				};
				
				Signaling.addUserGroup("@groupId",uid,success);
			}
			
			function candidate_search(query){
				
				var result = function(array){
					var html = "";
					for(var i  in array){
						var uid = array[i].uid;
						
						var add_button = "<button onclick='add_user_group(\""+uid+"\")'>add</button>";
						html += "<li>"+array[i].email+add_button+"</li>";
					}
					$("#candidate-list").html(html);	
				};
				Signaling.searchGroupCandidates("@groupId",query,result);
			}

			
			
			
			
		</script>
	</body>
</html>